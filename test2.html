<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ganga Boat Tracker</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">

  <!-- Google Font (elegant look) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#071426;
      --card:#0f2433;
      --muted:#9aa8b4;
      --accent:#2bb4ff;
      --accent-2:#2d9ef6;
      --glass: rgba(255,255,255,0.03);
      --shadow: 0 8px 30px rgba(8,18,28,0.6);
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Inter",system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      background: radial-gradient(ellipse at 20% 10%, rgba(45,158,246,0.07), transparent 10%),
                  radial-gradient(ellipse at 80% 90%, rgba(43,180,255,0.03), transparent 10%),
                  linear-gradient(180deg,var(--bg) 0%, #071726 60%);
      color: #e8f1f7;
      -webkit-font-smoothing:antialiased;
    }

    /* Top nav bar */
    .topbar{
      background: rgba(0,6,12,0.6);
      padding: 12px 22px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .brand{font-weight:700; letter-spacing:0.3px}
    .clock{
      font-weight:800;
      font-size:30px;
      color:var(--accent);
      text-align:right;
      line-height:1;
    }
    .clock small{display:block; font-weight:400; color:var(--muted); font-size:11px; letter-spacing:1px;}

    /* Header */
    .hero{
      text-align:center;
      padding:50px 16px 10px;
    }
    .hero h1{
      font-size:48px;
      margin: 12px 0;
      font-weight:800;
      letter-spacing:-1px;
    }
    .hero p{color:var(--muted); margin-bottom:26px}

    /* layout */
    .content{
      max-width:1100px;
      margin: 0 auto 80px;
      padding: 0 18px;
      display:flex;
      gap:28px;
      align-items:flex-start;
    }

    /* left card */
    .card-glass{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:14px;
      border: 1px solid rgba(255,255,255,0.03);
      padding:26px;
      box-shadow:var(--shadow);
    }
    .left{
      flex:0 0 380px;
    }
    .right{
      flex:1;
      min-height:420px;
    }

    .btn-accent{
      background: linear-gradient(90deg,var(--accent),var(--accent-2));
      border:none;
      box-shadow: 0 6px 20px rgba(45,158,246,0.18);
    }

    /* results list look */
    .results-card{
      padding:20px;
      border-radius:14px;
      background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));
      border: 1px solid rgba(255,255,255,0.03);
    }
    .route-title{font-weight:700; font-size:18px}
    .status-pill{background:#0a8b49;color:white;padding:6px 10px;border-radius:999px; font-size:12px; font-weight:700}

    .times-list{
      margin-top:18px;
      background: #071224;
      border-radius:10px;
      max-height:360px;
      overflow:auto;
      padding:10px;
      border:1px solid rgba(255,255,255,0.03);
    }
    .time-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px;
      margin-bottom:8px;
      background: linear-gradient(90deg, rgba(255,255,255,0.01), transparent);
      border-radius:8px;
      box-shadow: inset 0 -1px rgba(255,255,255,0.01);
    }
    .time-row .time{font-weight:700}
    .time-row .tag{background:rgba(255,255,255,0.04); padding:6px 10px; border-radius:999px; font-size:13px; color:var(--muted)}

    /* blinking side light when results show */
    .highlight-blink{
      position:relative;
      overflow:visible;
    }
    .highlight-blink::after{
      content:"";
      position:absolute;
      right:-8px;
      top:20%;
      width:8px;
      height:80px;
      background: linear-gradient(180deg, rgba(43,180,255,0.9), rgba(43,180,255,0.2));
      border-radius:4px;
      transform-origin:center;
      opacity:0;
      box-shadow:0 8px 20px rgba(43,180,255,0.14);
    }
    .highlight-blink.active::after{
      animation: blink 1s ease-in-out infinite;
      opacity:1;
    }
    @keyframes blink{
      0%{transform:scaleY(0.7); opacity:0.25}
      50%{transform:scaleY(1.1); opacity:1}
      100%{transform:scaleY(0.7); opacity:0.25}
    }

    /* boat animation strip */
    .boat-strip{
      margin-top:20px;
      height:120px;
      position:relative;
      overflow:hidden;
    }
    .water{
      position:absolute;
      left:-30%;
      right:-30%;
      bottom:0;
      height:60px;
      background: repeating-linear-gradient( -45deg, rgba(255,255,255,0.02) 0 8px, transparent 8px 16px);
      transform: translateY(6px);
      opacity:0.12;
    }
    .boat{
      position:absolute;
      left:-200px;
      top:10px;
      width:160px;
      transform: rotate(-6deg);
      filter: drop-shadow(0 8px 18px rgba(0,0,0,0.5));
      opacity:0.95;
    }
    .boat.sail{
      animation: boatmove 3.2s ease-out;
    }
    @keyframes boatmove{
      0%{left:-220px; transform:translateY(0) rotate(-6deg)}
      35%{left:45%; transform:translateY(-6px) rotate(-2deg)}
      70%{left:85%; transform:translateY(0) rotate(2deg)}
      100%{left:120%}
    }

    /* old-style big timer */
    .big-clock{
      font-family: 'Courier New', monospace;
      font-weight:800;
      font-size:42px;
      color:var(--accent-2);
      text-shadow: 0 4px 28px rgba(45,158,246,0.12);
      margin-bottom:18px;
    }

    /* small responsive */
    @media (max-width:900px){
      .content{display:block}
      .left{margin-bottom:18px}
    }

  </style>
</head>
<body>

  <!-- top nav -->
  <div class="topbar">
    <div class="brand">ðŸš¢ Ganga Boat Tracker</div>
    <div class="clock">
      <div id="deviceClock" class="big-clock">--:--:--</div>
      <small>YOUR DEVICE'S CURRENT TIME</small>
    </div>
  </div>

  <!-- header -->
  <div class="hero">
    <h1>Find your next boat across the Ganga</h1>
    <p>Check real-time departures and upcoming sailings â€” simple, clear, and local.</p>

    <!-- boat animated strip -->
    <div class="boat-strip" aria-hidden="true">
      <svg class="boat" id="boatSVG" viewBox="0 0 512 256" xmlns="http://www.w3.org/2000/svg">
        <!-- simple stylized boat -->
        <g>
          <rect x="40" y="140" width="420" height="36" rx="18" fill="#0b2b3a"/>
          <path d="M430 160c0 10-50 28-190 28S50 170 50 160" fill="#0b2b3a"/>
          <polygon points="230,40 270,100 190,100" fill="#fff"/>
          <rect x="250" y="68" width="10" height="40" rx="2" fill="#382f2f"/>
        </g>
      </svg>

      <div class="water"></div>
    </div>
  </div>

  <!-- main content -->
  <div class="content">
    <!-- left: selector -->
    <div class="left card-glass">
      <h4 class="mb-2">Choose your boarding ghat</h4>
      <p class="text-muted" style="margin-bottom:18px">Select the direction you're travelling.</p>

      <div class="mb-3">
        <label class="form-label small text-muted">Route (city â†” city)</label>
        <select id="routeSelect" class="form-select form-select-lg">
          <!-- options filled dynamically -->
        </select>
      </div>

      <button id="findBtn" class="btn btn-lg btn-accent w-100 mb-2">
        <span style="margin-right:8px">â›µ</span> Find my next boat
      </button>

      <p class="text-muted small mt-2">Around noon, services pause for high tide (about 12:00â€“12:45). Times shown are local device time.</p>
    </div>

    <!-- right: results -->
    <div class="right">
      <div id="resultsCard" class="results-card highlight-blink">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <div id="routeTitle" class="route-title">Route details</div>
            <div id="routeDirection" class="text-muted" style="font-size:13px">â€”</div>
          </div>
          <div id="statusPill" class="status-pill">Status</div>
        </div>

        <div id="nextBoatText" class="text-muted mb-2">Today's departures Â· Next boat at â€”</div>

        <div class="times-list" id="timesList" aria-live="polite">
          <!-- times rendered here -->
        </div>
      </div>
    </div>
  </div>

  <!-- SCRIPT: inline for convenience -->
  <script>
    // === sample data fallback for two routes ===
    const fallbackRoutes = [
      {
        id: "rishra-khardaha",
        title: "Rishra â†” Khardaha",
        from: "Rishra",
        to: "Khardaha",
        startTime: "05:00", // first service
        endTime: "22:20",   // last service (10:20 pm)
        frequencyMins: 20,
        durationMins: [5,7], // can vary
        highTidePause: {start:"12:00", durationMins:45}
      },
      {
        id: "konnagar-sodepur",
        title: "Konnagar â†” Sodepur",
        from: "Konnagar",
        to: "Sodepur",
        startTime: "05:00",
        endTime: "22:20",
        frequencyMins: 10,
        durationMins: [6],
        highTidePause: {start:"12:00", durationMins:45}
      }
    ];

    // utility: parse HH:MM to minutes since midnight
    function hmToMin(hm){
      const [h,m] = hm.split(":").map(Number);
      return h*60 + m;
    }
    function minToHm(min){
      min = ((min % 1440) + 1440) % 1440;
      const hh = Math.floor(min/60);
      const mm = Math.floor(min%60);
      const ampm = hh >= 12 ? 'pm' : 'am';
      const hr12 = (hh%12) === 0 ? 12 : hh%12;
      return String(hr12).padStart(2,'0') + ":" + String(mm).padStart(2,'0') + " " + ampm;
    }

    // fetch routes from backend if available, fallback to built-in data
    async function loadRoutes(){
      try{
        const res = await fetch('/api/routes');
        if(!res.ok) throw new Error('no api');
        const data = await res.json();
        return data.length ? data : fallbackRoutes;
      }catch(e){
        return fallbackRoutes;
      }
    }

    // compute schedule list for a route for today
    function computeSchedule(route){
      const start = hmToMin(route.startTime);
      const end = hmToMin(route.endTime);
      const list = [];
      for(let t=start; t<=end; t += route.frequencyMins){
        list.push(t);
      }
      // remove times during high tide pause
      if(route.highTidePause){
        const pauseStart = hmToMin(route.highTidePause.start);
        const pauseEnd = pauseStart + route.highTidePause.durationMins;
        return list.filter(min => !(min >= pauseStart && min < pauseEnd));
      }
      return list;
    }

    // UI references
    const routeSelect = document.getElementById('routeSelect');
    const findBtn = document.getElementById('findBtn');
    const resultsCard = document.getElementById('resultsCard');
    const routeTitle = document.getElementById('routeTitle');
    const routeDirection = document.getElementById('routeDirection');
    const statusPill = document.getElementById('statusPill');
    const nextBoatText = document.getElementById('nextBoatText');
    const timesList = document.getElementById('timesList');
    const boatSVG = document.getElementById('boatSVG');

    let ROUTES = [];
    async function init(){
      ROUTES = await loadRoutes();

      // populate select
      routeSelect.innerHTML = ROUTES.map(r => {
        return `<option value="${r.id}">${r.title}</option>`;
      }).join('');

      // show default selected
      renderRoute(ROUTES[0]);

      // update clock every second
      setInterval(updateClock,1000);
      updateClock();
    }

    function findRouteById(id){
      return ROUTES.find(r => r.id === id);
    }

    // render a route's schedule into the right pane
    function renderRoute(route){
      routeTitle.textContent = route.title;
      routeDirection.textContent = `${route.from} â†’ ${route.to}`;
      statusPill.textContent = "Running today";
      // compute schedule
      const schedule = computeSchedule(route);
      // build time rows (all today)
      timesList.innerHTML = schedule.map(min => {
        // tag departed/upcoming/now
        const now = new Date();
        const nowMin = now.getHours()*60 + now.getMinutes();
        let tag = '';
        if(min + 5 < nowMin) tag = 'Departed';
        else if(min <= nowMin && nowMin <= min + 6) tag = 'Now';
        else tag = 'Upcoming';
        return `
          <div class="time-row">
            <div class="time">${minToHm(min)}</div>
            <div class="tag">${tag}</div>
          </div>
        `;
      }).join('');

      // find next against now
      const nowMin = new Date().getHours()*60 + new Date().getMinutes();
      const next = schedule.find(s => s > nowMin);
      nextBoatText.textContent = `Today's departures Â· Next boat at ${ next ? minToHm(next) : 'â€”' }`;

      // add highlight blink briefly
      resultsCard.classList.add('active');
      setTimeout(()=> resultsCard.classList.remove('active'), 5000);
    }

    // animate boat (short sail)
    function animateBoat(){
      boatSVG.classList.remove('sail');
      void boatSVG.offsetWidth;
      boatSVG.classList.add('sail');
    }

    // Find button handler
    findBtn.addEventListener('click', async () => {
      findBtn.disabled = true;
      findBtn.classList.add('disabled');

      // play boat animation and a small ripple
      animateBoat();

      const id = routeSelect.value;
      const route = findRouteById(id) || ROUTES[0];

      // small fake delay to show animation
      await new Promise(res => setTimeout(res, 700));
      renderRoute(route);

      // re-enable
      findBtn.disabled = false;
      findBtn.classList.remove('disabled');
    });

    // also render on select change
    routeSelect.addEventListener('change', ()=>{
      const route = findRouteById(routeSelect.value);
      renderRoute(route);
    });

    // device clock
    function updateClock(){
      const d = new Date();
      let hh = d.getHours();
      const mm = d.getMinutes();
      const ss = d.getSeconds();
      const ampm = hh >= 12 ? 'pm' : 'am';
      let hr12 = hh % 12; hr12 = hr12 === 0 ? 12 : hr12;
      const timeStr = String(hr12).padStart(2,'0') + ":" + String(mm).padStart(2,'0') + ":" + String(ss).padStart(2,'0') + " " + ampm;
      document.getElementById('deviceClock').textContent = timeStr;
    }

    // init page
    init();

    // If user has an API that returns route objects with the same fields, it'll use them.
    // Example expected fields per route: { id, title, from, to, startTime: "05:00", endTime:"22:20", frequencyMins: 20, highTidePause:{start:"12:00", durationMins:45} }
  </script>

</body>
</html>
